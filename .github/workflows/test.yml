name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and run tests
        run: |
          set -e
          make clean
          make test 2>&1 | tee test_output.txt
          exit ${PIPESTATUS[0]}

      - name: Build main binary
        run: make all

      - name: Run tests with AddressSanitizer
        env:
          # Disable leak detection - there are pre-existing leaks in sync.c
          # that need separate attention. Keep use-after-free detection which
          # is what we need for issues like #12.
          ASAN_OPTIONS: detect_leaks=0
        run: |
          set -e
          make clean
          make test \
            CFLAGS="-std=c11 -Wall -Wextra -Wpedantic -O1 -g -fsanitize=address -fno-omit-frame-pointer -Iinclude -pthread" \
            LDFLAGS="-pthread -fsanitize=address" \
            2>&1 | tee asan_output.txt
          exit ${PIPESTATUS[0]}
